name: Auto Sync Real Upstream

on:
  schedule:
    - cron: "0 */12 * * *"   # æ¯ 12 å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # æ‹‰å®Œæ•´å†å²ï¼Œä¾¿äº merge

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # è‡ªåŠ¨æ£€æµ‹å½“å‰ä»“åº“çš„çœŸå®ä¸Šæ¸¸å’Œé»˜è®¤åˆ†æ”¯
      - name: Detect upstream repo & branch
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          api="https://api.github.com/repos/${GITHUB_REPOSITORY}"
          echo "è°ƒç”¨ GitHub API: $api"

          # æ‹‰å–å½“å‰ä»“åº“ä¿¡æ¯ï¼ˆåŒ…æ‹¬ parentï¼‰
          json=$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$api")

          is_fork=$(echo "$json" | jq -r '.fork')

          if [ "$is_fork" != "true" ]; then
            echo "å½“å‰ä»“åº“ä¸æ˜¯ fork ä»“åº“ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi

          upstream_full_name=$(echo "$json" | jq -r '.parent.full_name')
          upstream_default_branch=$(echo "$json" | jq -r '.parent.default_branch')

          echo "æ£€æµ‹åˆ°çœŸå®ä¸Šæ¸¸ï¼š$upstream_full_name"
          echo "ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼š$upstream_default_branch"

          if [ -z "$upstream_full_name" ] || [ "$upstream_full_name" = "null" ]; then
            echo "æœªèƒ½è·å–ä¸Šæ¸¸ä»“åº“åç§°ï¼Œé€€å‡ºã€‚"
            exit 1
          fi

          if [ -z "$upstream_default_branch" ] || [ "$upstream_default_branch" = "null" ]; then
            echo "æœªèƒ½è·å–ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼Œé»˜è®¤ä½¿ç”¨ mainã€‚"
            upstream_default_branch="main"
          fi

          echo "upstream_repo=$upstream_full_name" >> "$GITHUB_OUTPUT"
          echo "upstream_branch=$upstream_default_branch" >> "$GITHUB_OUTPUT"

      # æ ¹æ®â€œçœŸå®ä¸Šæ¸¸ + é»˜è®¤åˆ†æ”¯â€è¿›è¡ŒåŒæ­¥
      - name: Sync from real upstream
        run: |
          set -e

          UPSTREAM_REPO="${{ steps.detect.outputs.upstream_repo }}"
          UPSTREAM_BRANCH="${{ steps.detect.outputs.upstream_branch }}"

          echo "ä½¿ç”¨çš„ä¸Šæ¸¸ä»“åº“ï¼š$UPSTREAM_REPO"
          echo "ä½¿ç”¨çš„ä¸Šæ¸¸åˆ†æ”¯ï¼š$UPSTREAM_BRANCH"

          if [ -z "$UPSTREAM_REPO" ]; then
            echo "æ²¡æœ‰è·å–åˆ°ä¸Šæ¸¸ä»“åº“ï¼Œé€€å‡ºã€‚"
            exit 1
          fi

          # é…ç½® upstream è¿œç¨‹
          git remote add upstream "https://github.com/$UPSTREAM_REPO.git" || true
          git remote set-url upstream "https://github.com/$UPSTREAM_REPO.git"

          # æ‹‰å–ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯
          git fetch upstream "$UPSTREAM_BRANCH"

          # ç¡®ä¿å½“å‰ä¹Ÿåœ¨åŒååˆ†æ”¯ï¼ˆä¸å­˜åœ¨å°±æ–°å»ºï¼‰
          git checkout "$UPSTREAM_BRANCH" 2>/dev/null || git checkout -b "$UPSTREAM_BRANCH"

          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse "upstream/$UPSTREAM_BRANCH")

          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "ğŸ’¤ ä¸Šæ¸¸æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          git merge "upstream/$UPSTREAM_BRANCH" --no-edit
          git push origin "$UPSTREAM_BRANCH"
          echo "âœ… åŒæ­¥å®Œæˆ"
