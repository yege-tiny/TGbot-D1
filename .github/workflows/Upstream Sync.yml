name: Upstream Sync

on:
  schedule:
    - cron: "0 0 * * *"    # æ¯å¤© 00:00 UTCï¼ˆå¯æŒ‰éœ€æ”¹ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  upstream-sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    env:
      RETRIES: 2            # å‡ºé”™è‡ªåŠ¨é‡è¯•æ¬¡æ•°ï¼ˆåŒ…å«ç¬¬ä¸€æ¬¡ï¼Œå…± RETRIES æ¬¡æ‰§è¡Œï¼‰
      SYNC_COMMIT_PREFIX: "chore: sync with upstream"

    steps:
      - name: Checkout fork (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get upstream repo info via GitHub API
        id: upstream_info
        run: |
          # é€šè¿‡ GitHub REST API è·å– fork çš„ parentï¼ˆä¸Šæ¸¸ï¼‰ä¿¡æ¯
          API="https://api.github.com/repos/${{ github.repository }}"
          PARENT_JSON=$(curl -s -H "Accept: application/vnd.github.v3+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API")
          PARENT_FULL=$(echo "$PARENT_JSON" | jq -r '.parent.full_name // empty')
          PARENT_DEFAULT_BRANCH=$(echo "$PARENT_JSON" | jq -r '.parent.default_branch // empty')

          if [ -z "$PARENT_FULL" ] || [ "$PARENT_FULL" = "null" ]; then
            echo "ERROR: æ— æ³•ä» GitHub API è·å–ä¸Šæ¸¸ä¿¡æ¯ï¼Œå¯èƒ½è¯¥ä»“åº“ä¸æ˜¯ fork æˆ– API å—é™ã€‚"
            exit 1
          fi

          echo "parent=$PARENT_FULL" >> $GITHUB_OUTPUT
          echo "parent_default_branch=$PARENT_DEFAULT_BRANCH" >> $GITHUB_OUTPUT
        env:
          # ç”¨ GITHUB_TOKEN è°ƒç”¨ APIï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote and fetch everything (tags/releases included)
        run: |
          UPSTREAM="${{ steps.upstream_info.outputs.parent }}"
          echo "Upstream repo: $UPSTREAM"
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/$UPSTREAM.git"
          # å¼ºåˆ¶æ‹‰å–å…¨éƒ¨ refsï¼ˆé¿å…ç¼“å­˜/æµ…å…‹éš†å¯¼è‡´è¯¯åˆ¤ï¼‰
          git fetch --all --prune --tags

      - name: Determine upstream default branch (stable)
        id: detect_branch
        run: |
          # ä¼˜å…ˆä½¿ç”¨ API è¿”å›çš„ default_branchï¼Œå¦‚ä¸å­˜åœ¨å†é€€å›åˆ° ls-remote æ£€æµ‹
          BRANCH="${{ steps.upstream_info.outputs.parent_default_branch }}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "null" ]; then
            BRANCH=$(git ls-remote --symref upstream HEAD | awk '/^ref:/ {print $2}' | sed 's#refs/heads/##')
          fi
          if [ -z "$BRANCH" ]; then
            echo "æ— æ³•è¯†åˆ«ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          echo "upstream_branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Check upstream vs local (with retries)
        id: check_updates
        run: |
          set -e
          tries=0
          while [ $tries -lt $RETRIES ]; do
            tries=$((tries+1))
            echo "æ£€æŸ¥ç¬¬ $tries æ¬¡..."
            # ç¡®ä¿ refs æœ€æ–°
            git fetch upstream ${ { steps.detect_branch.outputs.upstream_branch } } || true
            UP_COMMIT=$(git rev-parse "upstream/${{ steps.detect_branch.outputs.upstream_branch }}" 2>/dev/null || echo "")
            LOCAL_COMMIT=$(git rev-parse "origin/${{ github.ref_name }}" 2>/dev/null || git rev-parse HEAD)
            echo "upstream commit: $UP_COMMIT"
            echo "local commit:    $LOCAL_COMMIT"

            if [ -z "$UP_COMMIT" ]; then
              echo "è­¦å‘Šï¼šæœªèƒ½è¯»å– upstream commitï¼Œé‡è¯•ï¼ˆè‹¥å¤šæ¬¡å¤±è´¥è¯·æ£€æŸ¥ä¸Šæ¸¸ä»“åº“å¯è®¿é—®æ€§ï¼‰"
              sleep 3
              continue
            fi

            if [ "$UP_COMMIT" = "$LOCAL_COMMIT" ]; then
              echo "changed=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "æ£€æŸ¥å¤±è´¥ï¼Œè¾¾åˆ°é‡è¯•ä¸Šé™ã€‚"
          exit 1

      - name: Merge upstream into local and push (only if changed)
        if: steps.check_updates.outputs.changed == 'true'
        run: |
          set -e
          UP_BRANCH="${{ steps.detect_branch.outputs.upstream_branch }}"
          echo "å‡†å¤‡åˆå¹¶ upstream/$UP_BRANCH åˆ°æœ¬åœ° ${GITHUB_REF_NAME:-${{ github.ref_name }}}"
          # å†æ¬¡ fetch ç¡®ä¿æœ€æ–°
          git fetch upstream $UP_BRANCH
          # checkout åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚ actions checkout çš„ ref_name æ— æ³•ç”¨ï¼Œåˆ™åˆ‡å› main/masterï¼‰
          TARGET_BRANCH="${GITHUB_REF_NAME:-${{ github.ref_name }}}"
          # è‹¥ TARGET_BRANCH ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨ upstream é»˜è®¤åˆ†æ”¯å
          if [ -z "$TARGET_BRANCH" ] || [ "$TARGET_BRANCH" = "refs/heads/" ]; then
            TARGET_BRANCH="$UP_BRANCH"
          fi
          git checkout -B "$TARGET_BRANCH" "origin/$TARGET_BRANCH" || git checkout -B "$TARGET_BRANCH"
          # åˆå¹¶ä¸Šæ¸¸åˆ†æ”¯ï¼ˆé fast-forward æ—¶ä¿ç•™åˆå¹¶è®°å½•ï¼‰
          git merge --no-edit "upstream/$UP_BRANCH" || true

          # ç”ŸæˆåŒæ­¥æäº¤ä¿¡æ¯ï¼ˆåŒ…å«ä¸Šæ¸¸ commitï¼‰
          UP_COMMIT=$(git rev-parse "upstream/$UP_BRANCH")
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_MSG="${SYNC_COMMIT_PREFIX} ${UP_BRANCH} (${TS}) - upstream@${UP_COMMIT}"
          git commit --allow-empty -m "$COMMIT_MSG" || true

          # æ¨é€åˆ° originï¼ˆä½¿ç”¨ actions è‡ªåŠ¨ tokenï¼‰
          # æ³¨æ„ï¼šæ¨é€ workflows å¯èƒ½è¢«æ‹’ç»ï¼ˆå¦‚æœè¢«æ‹’ç»ï¼Œè¯·æŒ‰æ—¥å¿—æç¤ºè®¾ç½® PATï¼‰
          git push origin "$TARGET_BRANCH" --follow-tags

      - name: Sync tags/releases (if any new)
        if: steps.check_updates.outputs.changed == 'true'
        run: |
          # æ¨é€ tagsï¼ˆæœ¬åœ°å·² fetch upstream çš„ tagsï¼‰
          # ä»…æ¨é€ upstream æ–°çš„ tag åˆ° origin
          echo "åŒæ­¥ tags åˆ° originï¼ˆè‹¥æœ‰ï¼‰"
          # æ‰¾åˆ° upstream tag åˆ—è¡¨å¹¶æ¨é€å¯¹åº” tag
          for t in $(git ls-remote --tags upstream | awk '{print $2}' | sed 's#refs/tags/##' | grep -v '{}' || true); do
            if ! git ls-remote --tags origin | grep -q "refs/tags/$t"; then
              echo "æ¨é€ tag: $t"
              git push origin "refs/tags/$t"
            fi
          done

      - name: Sync .github/workflows from upstream (optional, may require PAT)
        if: steps.check_updates.outputs.changed == 'true'
        run: |
          # å°†ä¸Šæ¸¸çš„ .github/workflows ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°æœ¬ä»“åº“å¹¶æäº¤
          echo "å°è¯•åŒæ­¥ .github/workflows æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šè‹¥ä½¿ç”¨ GITHUB_TOKEN æ¨é€ workflow å¯èƒ½è¢«ç¦æ­¢ï¼‰"
          TMPDIR=$(mktemp -d)
          git --work-tree="$TMPDIR" checkout upstream/${{ steps.detect_branch.outputs.upstream_branch }} -- .github/workflows || true
          if [ -d "$TMPDIR/.github/workflows" ]; then
            cp -r "$TMPDIR/.github/workflows" .github/ || true
            git add .github/workflows || true
            git commit -m "${SYNC_COMMIT_PREFIX} sync workflows (${{ steps.detect_branch.outputs.upstream_branch }})" || true
            # å°è¯•ä½¿ç”¨ GITHUB_TOKEN æ¨é€
            if git push origin HEAD:${GITHUB_REF_NAME:-${{ github.ref_name }}}; then
              echo "workflows æ¨é€æˆåŠŸã€‚"
            else
              echo "è­¦å‘Šï¼šä½¿ç”¨ GITHUB_TOKEN æ¨é€ workflows è¢«æ‹’ç»ã€‚è‹¥éœ€è¦å¼ºåˆ¶åŒæ­¥ workflowsï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­è®¾ç½®åä¸º UPSTREAM_SYNC_TOKEN çš„ PATï¼ˆrepo æƒé™ï¼‰ï¼Œå¹¶æ‰‹åŠ¨é‡æ–°è¿è¡Œã€‚"
            fi
          else
            echo "ä¸Šæ¸¸æ²¡æœ‰ .github/workflowsï¼Œæˆ–æ— æ³•æ£€å‡ºã€‚"
          fi

      - name: Finish message
        run: |
          if [ "${{ steps.check_updates.outputs.changed }}" = "true" ]; then
            echo "ğŸ‰ å·²å®Œæˆä¸ä¸Šæ¸¸åŒæ­¥ã€‚"
          else
            echo "âœ… ä¸Šæ¸¸æ— æ›´æ–°ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚"
          fi
